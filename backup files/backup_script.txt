document.addEventListener('DOMContentLoaded', function () {
    const peer = new Peer();

    document.getElementById('sendOption').addEventListener('click', () => {
        document.getElementById('options').style.display = 'none';
        document.getElementById('sendFileContainer').style.display = 'block';
    });

    document.getElementById('receiveOption').addEventListener('click', () => {
        document.getElementById('options').style.display = 'none';
        document.getElementById('receiveFileContainer').style.display = 'block';
    });

    peer.on('open', (peerId) => {
        console.log('My peer ID is: ' + peerId);
        document.getElementById('fileUrl').value = `${window.location.href}?file=${peerId}`;
    });

    peer.on('error', (error) => {
        console.error('PeerJS error:', error);
    });

    document.getElementById('sendButton').addEventListener('click', () => {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
            alert('Please select a file to send.');
            return;
        }

        const fileReader = new FileReader();
        fileReader.readAsArrayBuffer(file);
        fileReader.onload = (event) => {
            const arrayBuffer = event.target.result;
            const chunkSize = 16 * 1024; // 16 KB
            const chunks = [];
            for (let i = 0; i < arrayBuffer.byteLength; i += chunkSize) {
                chunks.push(arrayBuffer.slice(i, i + chunkSize));
            }

            const fileUrl = `${window.location.href}?file=${peer.id}`;
            document.getElementById('fileUrl').value = fileUrl;
            document.getElementById('fileLink').style.display = 'block';

            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    conn.send({
                        fileName: file.name,
                        fileSize: file.size,
                        totalChunks: chunks.length
                    });

                    chunks.forEach((chunk, index) => {
                        conn.send({ index, chunk });
                    });
                });
            });
        };
    });

    document.getElementById('receiveButton').addEventListener('click', () => {
        const fileLinkInput = document.getElementById('fileLinkInput').value;
        const urlParams = new URLSearchParams(fileLinkInput.split('?')[1]);
        const senderPeerId = urlParams.get('file');

        const conn = peer.connect(senderPeerId);

        let receivedChunks = [];
        let totalChunks = 0;
        let fileName = '';

        // Display a status message indicating file receiving process has started
        const statusMessage = document.createElement('p');
        statusMessage.textContent = 'Receiving file...';
        document.getElementById('receiveFileContainer').appendChild(statusMessage);

        // Progress indicator
        const progressBar = document.createElement('progress');
        progressBar.value = 0;
        progressBar.max = 100;
        document.getElementById('receiveFileContainer').appendChild(progressBar);

        conn.on('open', () => {
            console.log('Connected to sender:', senderPeerId);
        });

        conn.on('data', (data) => {
            if (data.fileName) {
                fileName = data.fileName;
                totalChunks = data.totalChunks;
            } else {
                receivedChunks[data.index] = data.chunk;

                // Calculate progress
                const progress = Math.round((receivedChunks.filter(Boolean).length / totalChunks) * 100);
                progressBar.value = progress;

                // Check if all chunks have been received
                if (receivedChunks.filter(Boolean).length === totalChunks) {
                    // Hide the status message and progress bar when file receiving is complete
                    statusMessage.textContent = 'File received successfully!';
                    progressBar.style.display = 'none';

                    // Create a blob from received chunks
                    const blob = new Blob(receivedChunks, { type: 'application/octet-stream' });

                    // Create temporary anchor element for downloading the file
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    document.body.appendChild(a);

                    // Create URL for the blob and trigger download
                    const url = window.URL.createObjectURL(blob);
                    a.href = url;
                    a.download = fileName;
                    a.click();

                    // Clean up
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            }
        });

        conn.on('error', (error) => {
            console.error('Connection error:', error);
            // Display an error message if the connection encounters an error
            statusMessage.textContent = 'Error receiving file. Please try again.';
            progressBar.style.display = 'none';
        });
    });
});
